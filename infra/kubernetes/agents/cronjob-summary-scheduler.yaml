apiVersion: batch/v1
kind: CronJob
metadata:
  name: mindwell-summary-scheduler
  labels:
    app: mindwell-summary-scheduler
spec:
  schedule: "30 1 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            app: mindwell-summary-scheduler
        spec:
          serviceAccountName: mindwell-agents
          restartPolicy: OnFailure
          containers:
            - name: summary-scheduler
              image: ${BACKEND_IMAGE}
              imagePullPolicy: IfNotPresent
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  python - <<'PY'
                  import os
                  import subprocess

                  mode = (os.environ.get("SUMMARY_SCHEDULER_MODE") or "daily").strip() or "daily"
                  cmd = ["mindwell-summary-scheduler", mode]

                  date_value = (os.environ.get("SUMMARY_SCHEDULER_DATE") or "").strip()
                  if date_value:
                      cmd.extend(["--date", date_value])

                  subprocess.run(cmd, check=True)
                  PY
              envFrom:
                - configMapRef:
                    name: mindwell-agent-config
                - secretRef:
                    name: mindwell-backend
              volumeMounts:
                - name: agent-secrets
                  mountPath: /mnt/secrets
                  readOnly: true
          volumes:
            - name: agent-secrets
              csi:
                driver: secrets-store.csi.k8s.io
                readOnly: true
                volumeAttributes:
                  secretProviderClass: backend-secrets
