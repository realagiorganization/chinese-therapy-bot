Metadata-Version: 2.4
Name: mindwell-backend
Version: 0.1.0
Summary: MindWell API platform scaffolding.
Author-email: MindWell Engineering <engineering@mindwell.health>
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: fastapi<1.0,>=0.110
Requires-Dist: uvicorn[standard]<1.0,>=0.27
Requires-Dist: pydantic-settings<3.0,>=2.2
Requires-Dist: sqlalchemy<3.0,>=2.0
Requires-Dist: asyncpg<1.0,>=0.29
Requires-Dist: aioboto3<13.0,>=12.4
Requires-Dist: httpx<1.0,>=0.27
Requires-Dist: pyjwt[crypto]<3.0,>=2.8
Requires-Dist: cryptography<42,>=41
Requires-Dist: openai<2.0,>=1.12
Requires-Dist: python-multipart<0.1,>=0.0.6
Requires-Dist: alembic<2.0,>=1.13
Provides-Extra: dev
Requires-Dist: pytest<9.0,>=8.2; extra == "dev"
Requires-Dist: pytest-asyncio<0.24,>=0.23; extra == "dev"
Requires-Dist: aiosqlite<0.20,>=0.19; extra == "dev"
Requires-Dist: ruff<0.7,>=0.6; extra == "dev"
Requires-Dist: mypy<2.0,>=1.9; extra == "dev"
Requires-Dist: types-requests; extra == "dev"

# MindWell Backend Service

The backend is a FastAPI application that powers every surface of the MindWell
experience: oauth2-proxy session exchange, demo-code onboarding, streaming chat,
therapist ingestion, memory extraction, journey insights, Explore modules,
voice transcription, analytics, and operational guardrails. The same package
also ships the automation agents used by CI and scheduled jobs.

## Project Layout

```
services/backend/
  app/
    api/         # FastAPI routers (auth, chat, therapists, reports, analytics, voice, etc.)
    core/        # Settings, logging helpers, database/redis wiring, migrations bootstrap
    models/      # SQLAlchemy models + Alembic metadata
    schemas/     # Pydantic schemas shared by FastAPI responses and services
    services/    # Business logic (LLM orchestration, therapist import, feature flags, summaries, monitoring…)
    agents/      # CLI entry points (data sync, summaries, retention cleanup, analytics, monitoring)
    data/        # Packaged datasets (chat templates)
    main.py      # uvicorn entry point used by `mindwell-api`
  scripts/       # SAR tooling (`export_user_data.py`, `delete_user_data.py`, etc.)
  tests/         # pytest suite (unit + async integration tests)
  loadtests/     # Locust scenarios for chat/journey regression
```

## Quick Start

```bash
cd services/backend
python -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install -e ".[dev]"
cp ../demo_codes.sample.json config/demo_codes.json  # optional demo codes
export DATABASE_URL="postgresql+asyncpg://user:pass@localhost:5432/mindwell"
export DEMO_CODE_FILE="$PWD/config/demo_codes.json"
alembic upgrade head
mindwell-api
```

The API listens on `http://127.0.0.1:8000` (configurable via `API_HOST` /
`API_PORT`). When `RUN_MIGRATIONS_ON_STARTUP=1` the app executes Alembic
migrations automatically during the FastAPI lifespan hook.

## API Surface

### Authentication & Sessions
- `app/api/routes/auth.py` exposes `POST /api/auth/session`, `/demo`, and `/token/refresh`.
- `AuthService` issues JWT/refresh pairs for oauth2-proxy identities or demo
  codes, enforces chat-token quotas per user/code, and rotates refresh tokens with
  revocation tracking.
- Demo codes are loaded through `DemoCodeRegistry` from the JSON allowlist
  referenced by `DEMO_CODE_FILE`.

### Chat Orchestrator
- `POST /api/chat/message` streams Server-Sent Events via `ChatService` and the
  `ChatOrchestrator` wrapper (Azure OpenAI primary, OpenAI/Bedrock fallbacks).
- The service persists every message to Postgres plus S3
  (`ChatTranscriptStorage`), emits analytics via `ProductAnalyticsService`, and
  records quota usage.
- Conversation memory snapshots (`ConversationMemoryService`) and therapist
  recommendations (`TherapistRecommendationService` + `EmbeddingClient`) are
  returned with each turn to keep clients in sync.
- `/api/chat/templates` serves curated prompt templates from
  `app/data/chat_templates.json` with locale/topic filtering.

### Therapists & Recommendations
- `TherapistService` backs `/api/therapists` list/detail and admin import
  endpoints. Records live in Postgres with optional S3-backed imports.
- `mindwell-data-sync` normalizes upstream JSON/CSV feeds (HTTP or local files)
  and publishes `profile_<locale>.json` payloads to
  `S3_BUCKET_THERAPISTS`; the backend import endpoint ingests them.
- `TranslationService` enriches therapist localizations and powers ad-hoc
  translations for Explore modules and memory snippets.

### Journey Reports, Explore Modules & Feature Flags
- `/api/reports/{user_id}` aggregates daily/weekly summaries plus transcript
  slices via `ReportsService`, with analytics backfill when fresh data exists.
- `/api/explore/modules` composes breathing, psychoeducation, and trending cards
  gated by `FeatureFlagService` rollout percentages and personalized via recent
  journey signals.
- `/api/features` CRUD + evaluate endpoints expose runtime feature toggles for
  operators and automated tests.

### Voice, Translation & Summaries
- `/api/voice/transcribe` calls `AutomaticSpeechRecognitionService`, which wraps
  Azure Speech (`AzureSpeechTranscriber`) and rejects requests when server-side
  ASR isn’t configured.
- `SummaryGenerationService` synthesizes daily/weekly summaries from chat
  transcripts using the LLM orchestrator and writes them to Postgres + the
  `S3_SUMMARIES_BUCKET`. The `mindwell-summary-scheduler` CLI runs this pipeline
  on demand or scheduled cadences.
- `TranslationService` also powers `/api/translation/batch`, letting clients
  translate UI copy without duplicating prompt logic.

### Analytics, Monitoring & Data Governance
- `/api/analytics/events` records funnel events (chat turns, therapist clicks,
  signup milestones) and `/api/analytics/summary` exposes aggregated metrics.
- `mindwell-analytics-agent` wraps the same service to emit JSON snapshots on a
  cron (`--window-hours` + optional `--output` path).
- `MonitoringService` polls Application Insights p95 latency/error rates and AWS
  Cost Explorer spend; `mindwell-monitoring-agent` dispatches alerts via webhooks.
- `mindwell-retention-cleanup` enforces `conversation_logs_retention_months` /
  `daily_summary_retention_months` on the configured S3 buckets (dry-run and
  batch deletion supported).
- `DataSubjectService` plus the scripts under `services/backend/scripts/`
  implement SAR lookup/export/delete, including transcript/S3 scrubbing.

## Automation & CLI Entry Points

| Command | Purpose |
| --- | --- |
| `mindwell-summary-scheduler [daily|weekly|both] [--date YYYY-MM-DD]` | Generates daily/weekly summaries for active users. |
| `mindwell-data-sync --source <url|path>` | Normalizes therapist datasets and uploads locale payloads to S3. |
| `mindwell-retention-cleanup --include conversations,summaries [--dry-run]` | Deletes S3 objects that breach retention windows. |
| `mindwell-monitoring-agent [--dry-run]` | Runs latency/error/cost guardrails and optionally posts alerts. |
| `mindwell-analytics-agent --window-hours 24 --output analytics.json` | Produces product analytics summaries for growth dashboards. |

Run each command from the virtual environment configured earlier so the same
`AppSettings` and secrets are available.

## Testing & Quality

```bash
cd services/backend
pytest                        # async unit/integration tests
ruff check app                # lint
mypy app                      # type checks
```

- Integration tests spin up an in-memory SQLite database by default; set
  `DATABASE_URL` to point at Postgres when running end-to-end scenarios.
- Locust scenarios (`loadtests/`) stress chat/journey flows once the API is up.
- `scripts/export_user_data.py` / `scripts/delete_user_data.py` provide manual
  governance workflows and double as regression fixtures in `tests/`.
