name: LLM Key Rotation

on:
  workflow_dispatch:
    inputs:
      openai_api_key:
        description: "New OpenAI API key (optional when NEW_OPENAI_API_KEY secret is set)."
        required: false
        type: string
  schedule:
    - cron: "0 5 1 */2 *"

permissions:
  id-token: write
  contents: read

jobs:
  rotate-llm-keys:
    name: Rotate LLM Provider Keys
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
      OPENAI_SECRET_ID: ${{ vars.OPENAI_SECRET_ID || '' }}
      OPENAI_KEY_VAULT_SECRET_NAME: ${{ vars.OPENAI_KEY_VAULT_SECRET_NAME || 'openai-api-key' }}
      AZURE_KEY_VAULT_NAME: ${{ vars.AZURE_KEY_VAULT_NAME || '' }}
      S3_BUCKET_THERAPISTS: ${{ vars.S3_BUCKET_THERAPISTS || 'therapists-placeholder' }}
      NEW_OPENAI_API_KEY: ${{ github.event.inputs.openai_api_key || secrets.NEW_OPENAI_API_KEY || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify rotation inputs
        id: check-input
        shell: bash
        run: |
          if [[ -z "${NEW_OPENAI_API_KEY}" ]]; then
            echo "No NEW_OPENAI_API_KEY provided; skipping rotation." | tee -a "${GITHUB_STEP_SUMMARY}"
            echo "should_skip=true" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          if [[ -z "${OPENAI_SECRET_ID}" ]]; then
            echo "Repository variable OPENAI_SECRET_ID is required." >&2
            exit 1
          fi
          if [[ -z "${AZURE_KEY_VAULT_NAME}" ]]; then
            echo "Repository variable AZURE_KEY_VAULT_NAME is required." >&2
            exit 1
          fi
          if [[ -z "${OPENAI_KEY_VAULT_SECRET_NAME}" ]]; then
            echo "Repository variable OPENAI_KEY_VAULT_SECRET_NAME is required." >&2
            exit 1
          fi
          echo "should_skip=false" >> "${GITHUB_OUTPUT}"

      - name: Configure AWS credentials
        if: steps.check-input.outputs.should_skip != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_LLM_ROTATION_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Azure
        if: steps.check-input.outputs.should_skip != 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      - name: Set up Python
        if: steps.check-input.outputs.should_skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: services/backend/pyproject.toml

      - name: Install backend tooling
        if: steps.check-input.outputs.should_skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install ./services/backend

      - name: Rotate OpenAI API key in AWS Secrets Manager
        if: steps.check-input.outputs.should_skip != 'true'
        env:
          SECRET_VALUE: ${{ env.NEW_OPENAI_API_KEY }}
        run: |
          aws secretsmanager put-secret-value \
            --secret-id "${OPENAI_SECRET_ID}" \
            --secret-string "${SECRET_VALUE}" \
            --region "${AWS_REGION}"

      - name: Mirror OpenAI API key into Azure Key Vault
        if: steps.check-input.outputs.should_skip != 'true'
        env:
          DATA_SYNC_METRICS_PATH: rotation-metrics
          AWS_REGION: ${{ env.AWS_REGION }}
          AZURE_KEY_VAULT_NAME: ${{ env.AZURE_KEY_VAULT_NAME }}
          S3_BUCKET_THERAPISTS: ${{ env.S3_BUCKET_THERAPISTS }}
        run: |
          mindwell-data-sync \
            --mirror-secret "${OPENAI_SECRET_ID}:${OPENAI_KEY_VAULT_SECRET_NAME}"

      - name: Upload rotation metrics
        if: steps.check-input.outputs.should_skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: llm-key-rotation-metrics
          path: rotation-metrics
          if-no-files-found: ignore
