name: LLM Credential Rotation

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (e.g., dev, staging, prod)"
        required: true
        default: "dev"

permissions:
  contents: read
  id-token: write

concurrency:
  group: llm-rotation-${{ github.event.inputs.environment || 'manual' }}
  cancel-in-progress: false

jobs:
  rotate:
    name: Rotate credentials (${{ github.event.inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    env:
      ROTATION_ENV: ${{ github.event.inputs.environment || 'dev' }}
      ROTATION_PAYLOAD: ${{ secrets.LLM_ROTATION_PAYLOAD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate rotation payload
        id: payload
        env:
          ROTATION_ENV: ${{ env.ROTATION_ENV }}
          ROTATION_PAYLOAD: ${{ env.ROTATION_PAYLOAD }}
        run: |
          python - <<'PY'
import json
import os
from pathlib import Path

payload_raw = os.environ.get("ROTATION_PAYLOAD", "").strip()
if not payload_raw:
    raise SystemExit("LLM_ROTATION_PAYLOAD secret is not configured.")

try:
    payload = json.loads(payload_raw)
except json.JSONDecodeError as exc:
    raise SystemExit(f"Rotation payload must be valid JSON: {exc}") from exc

entries = payload.get("entries") or payload.get("secrets")
if not isinstance(entries, list) or not entries:
    raise SystemExit("Rotation payload must contain a non-empty 'entries' array.")

key_vault_name = payload.get("key_vault_name")
if not key_vault_name:
    raise SystemExit("Rotation payload must include 'key_vault_name'.")

payload_env = payload.get("environment")
rotation_env = os.environ["ROTATION_ENV"]
if payload_env and payload_env != rotation_env:
    raise SystemExit(
        f"Rotation payload targets '{payload_env}' but workflow dispatched for '{rotation_env}'."
    )

required_fields = ("aws_secret_id", "secret_string", "key_vault_secret_name")
for index, entry in enumerate(entries):
    if not isinstance(entry, dict):
        raise SystemExit(f"Entry {index} must be an object.")
    missing = [field for field in required_fields if not entry.get(field)]
    if missing:
        raise SystemExit(f"Entry {index} missing fields: {', '.join(missing)}")

entries_path = Path("rotation_entries.json")
entries_path.write_text(json.dumps(entries), encoding="utf-8")

output_path = Path(os.environ["GITHUB_OUTPUT"])
with output_path.open("a", encoding="utf-8") as handle:
    handle.write(f"entries-file={entries_path}\n")
    handle.write(f"key-vault-name={key_vault_name}\n")
PY

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_SECRET_ROTATION_ROLE_ARN }}
          role-session-name: llm-secret-rotation
          aws-region: ${{ secrets.AWS_REGION || 'ap-northeast-1' }}

      - name: Rotate AWS secrets
        env:
          ENTRIES_FILE: ${{ steps.payload.outputs.entries-file }}
        run: |
          python - <<'PY'
import json
import os
import subprocess
from pathlib import Path

entries = json.loads(Path(os.environ["ENTRIES_FILE"]).read_text(encoding="utf-8"))
for entry in entries:
    cmd = [
        "aws",
        "secretsmanager",
        "put-secret-value",
        "--secret-id",
        entry["aws_secret_id"],
        "--secret-string",
        entry["secret_string"],
    ]
    subprocess.run(cmd, check=True)
PY

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend CLI
        run: pip install ./services/backend

      - name: Mirror secrets to Key Vault
        env:
          ENTRIES_FILE: ${{ steps.payload.outputs.entries-file }}
          KEY_VAULT_NAME: ${{ steps.payload.outputs.key-vault-name }}
        run: |
          python - <<'PY'
import json
import os
import subprocess
from pathlib import Path

entries = json.loads(Path(os.environ["ENTRIES_FILE"]).read_text(encoding="utf-8"))
args = [
    "mindwell-data-sync",
    "--mode",
    "secrets",
    "--key-vault-name",
    os.environ["KEY_VAULT_NAME"],
]
for entry in entries:
    args.extend(
        [
            "--secret-map",
            f"{entry['aws_secret_id']}={entry['key_vault_secret_name']}",
        ]
    )
subprocess.run(args, check=True)
PY

      - name: Cleanup payload artifacts
        if: always()
        env:
          ENTRIES_FILE: ${{ steps.payload.outputs.entries-file }}
        run: |
          if [[ -n "${ENTRIES_FILE}" && -f "${ENTRIES_FILE}" ]]; then
            shred -u "${ENTRIES_FILE}" || rm -f "${ENTRIES_FILE}"
          fi
